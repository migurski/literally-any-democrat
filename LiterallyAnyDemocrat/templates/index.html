<html>
<head>
<title>Literally Any Democrat 2020</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='writ.min.css') }}">
<style>
    body { margin: 4em 15% }
    a { text-decoration: underline }
</style>
</head>
<body>

<h3>Literally Any Democrat in 2020</h3>
<p>
    So many Democrats are running for office in 2020! You can help take back
    the U.S. Senate or help fix legislature-controlled partisan gerrymandering
    by supporting these candidates throughout the year, but how should you
    pick one to support? <strong>Let us help you pick literally any Democrat at
    random.</strong>
</p>

<section id="candidate" style="display: none">
    <h1>
        <span id="name1">Joe Blow</span>
        is <span id="verb"></span>
        for <span id="race">Parliament</span>.
    </h1>
    
    <p id="reason">
        
    </p>
    
    <h2>
        üìÖ The <span id="election">general election is November 2020</span>,
        <a id="link" href="#" target="blank">support <span id="name2">Joe Blow</a> üí∞
    </h2>
</section>

<p>
    Reload this page to randomly pick someone else.
</p>

<hr>

<h3>How Can I Help?</h3>

<ul>
    <li>
        Support the campaigns of the candidates above.
    </li>
    <li>
        <a href="https://github.com/migurski/literally-any-democrat/issues/new?title=Add+candidate+link">Let us know about candidate campaign website or donation URLs</a>.
    </li>
    <li>
        <a href="https://github.com/migurski/literally-any-democrat/issues/new?title=New+candidates+are+available">Let us know if you see candidates</a>
        Ballotpedia‚Äôs
        <a href="https://ballotpedia.org/State_legislative_elections,_2020">State legislative elections</a>
        and <a href="https://ballotpedia.org/United_States_Senate_elections,_2020">U.S. Senate elections</a>
        pages who we haven‚Äôt included here.
    </li>
    <li>
        Support <a href="https://ballotpedia.org/Ballotpedia:Donate">Ballotpedia,
        whose candidate listings we use</a>.
    </li>
</ul>

<h3>What States Are Included?</h3>

<p>
    We are initially including candidates for
    <a href="https://swingleft.org/p/super-states">Swing Left Super States</a>
    whose filing deadlines have passed.
</p>

<blockquote>
    Last cycle, Swing Left pointed you towards your closest Swing District as
    the most effective place to focus your volunteer time and donations. And
    everybody is familiar with Swing States. But the 2020 cycle is giving us
    something new and exciting: what we‚Äôre calling the ‚ÄúSuper States.‚Äù If you
    overlay the target maps, the most important battles to win the White House,
    the Senate, and the once-in-a-decade fight to control redistricting are
    concentrated in the same few states. By focusing on them, we can maximize
    the impact of our efforts, working on many or all of these important
    contests at the same time.
</blockquote>

<p>
    Currently, that‚Äôs mostly Texas and North Carolina. We will add candidates
    as more filing deadlines pass and narrow them down to general election
    candidates after primary elections happen in Spring and Summer 2020.
</p>

<table>
    <thead>
        <tr>
            <th>State</th>
            <th>Chamber</th>
            <th>Reason</th>
            <th>Filing Deadline</th>
            <th>Primary Election</th>
            <th>Candidates</th>
        </tr> 
    </thead> 
    <tbody> 
        <tr id="first-state">
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
    </tbody>
</table>

<script language="javascript">

    function load_candidates(url)
    {
        var request = new XMLHttpRequest();
        request.open('GET', url, true);

        request.onload = function()
        {
            if(request.status >= 200 && request.status < 400)
            {
                // Returns a dict with head and rows lists
                var data = JSON.parse(request.responseText);
                pick_random_candidate(make_candidate_dicts(data['head'], data['rows']));
                return;
            }
        };

        request.onerror = function() { /* There was a connection error of some sort */ };
        request.send();
    }

    function make_candidate_dicts(head, rows)
    {
        var dicts = [], cumulative_weight = 0;
        
        for(var i = 0; i < rows.length; i++)
        {
            dicts.push({});

            for(var j = 0; j < head.length; j++)
            {
                dicts[i][head[j]] = rows[i][j];
            }
            
            // scale logarithmically so big state Senate races don't dominate
            dicts[i].weight = Math.log(dicts[i].weight);
            
            if(dicts[i].incumbent)
            {
                // return incumbents half as frequently
                dicts[i].weight /= 2;
            }
            
            dicts[i].filing_deadline = new Date(dicts[i].filing_deadline);
            dicts[i].primary_election = new Date(dicts[i].primary_election);
            dicts[i].cumulative_weight = cumulative_weight + dicts[i].weight;
            cumulative_weight = dicts[i].cumulative_weight;
        }
        
        console.log('Cumulative weight:', cumulative_weight);
        return dicts;
    }
    
    function pick_random_candidate(candidates)
    {
        console.log('Loaded candidates:', candidates.length);
        
        var total_weight = candidates[candidates.length - 1].cumulative_weight,
            random_cutoff = Math.random() * total_weight;
        
        for(var i = 0; i < candidates.length; i++)
        {
            if(candidates[i].cumulative_weight > random_cutoff)
            {
                return show_candidate(candidates[i]);
            }
        }
    }
    
    function show_candidate(candidate)
    {
        console.log('Random candidate:', candidate.name, candidate);
        document.getElementById('name1').innerHTML = candidate.name;
        document.getElementById('name2').innerHTML = candidate.name;
        
        if(candidate.incumbent) {
            document.getElementById('verb').innerHTML = 'running as an incumbent';

        } else {
            document.getElementById('verb').innerHTML = 'seeking their first term';
        }
        
        if((new Date()) < candidate.primary_election)
        {
            document.getElementById('election').innerHTML = [
                candidate.state, 'primary election is coming up',
                candidate.primary_election.toLocaleDateString()].join(' ');
        }
        
        if(candidate.reason == 'Redistricting') {
            document.getElementById('reason').innerHTML = ['The',
                candidate.chamber, 'will determine', candidate.state,
                'district boundaries for 2021-2030, including U.S. Congressional',
                'districts. A win by', candidate.name, 'helps a once-in-a-decade',
                'chance to control redistricting.'].join(' ');
        
        } else if(candidate.reason == 'Senate Control') {
            document.getElementById('reason').innerHTML = ['The U.S. Senate approves',
            'judicial nominees and determines the makeup of the Supreme Court.',
            'A win by', candidate.name, 'helps Democrats win the Senate.'].join(' ');
        
        } else {
            document.getElementById('reason').style.display = 'none';
        }
        
        var phrase = ['the', candidate.state, candidate.chamber, 'in District', candidate.district].join(' '),
            search = [candidate.name, candidate.state, candidate.chamber, 'District', candidate.district].join(' ');
        
        if(candidate.chamber == 'U.S. Senate')
        {
            phrase = ['the', candidate.chamber, 'in', candidate.state].join(' ');
            search = [candidate.name, candidate.chamber, candidate.state].join(' ');
        }

        document.getElementById('race').innerHTML = phrase;
        document.getElementById('link').href = 'https://www.google.com/search?q=support+campaign+' + escape(search);
        document.getElementById('candidate').style.display = 'block';
    }

    function load_states(url)
    {
        var request = new XMLHttpRequest();
        request.open('GET', url, true);

        request.onload = function()
        {
            if(request.status >= 200 && request.status < 400)
            {
                // Returns a dict with head and rows lists
                var data = JSON.parse(request.responseText);
                show_states(make_state_dicts(data['head'], data['rows']));
                return;
            }
        };

        request.onerror = function() { /* There was a connection error of some sort */ };
        request.send();
    }

    function make_state_dicts(head, rows)
    {
        var dicts = [];
        
        for(var i = 0; i < rows.length; i++)
        {
            dicts.push({});

            for(var j = 0; j < head.length; j++)
            {
                dicts[i][head[j]] = rows[i][j];
            }

            dicts[i].filing_deadline = new Date(dicts[i].filing_deadline);
            dicts[i].primary_election = new Date(dicts[i].primary_election);
        }
        
        return dicts;
    }
    
    function show_states(states)
    {
        var first_row = document.getElementById('first-state'),
            table_body = first_row.parentNode,
            template_row = table_body.removeChild(first_row);
        
        for(var i = 0; i < states.length; i++)
        {
            var new_row = template_row.cloneNode(true),
                row_cells = new_row.getElementsByTagName('TD');
            
            row_cells[0].innerHTML = states[i].state;
            row_cells[1].innerHTML = states[i].chamber;
            row_cells[2].innerHTML = states[i].reason;
            
            if(states[i].filing_deadline < (new Date())) {
                row_cells[3].innerHTML = ('<strike>' 
                    + states[i].filing_deadline.toLocaleDateString() + '</strike>');
            
            } else {
                row_cells[3].innerHTML = states[i].filing_deadline.toLocaleDateString();
            }
            
            if(states[i].primary_election < (new Date())) {
                row_cells[4].innerHTML = ('<strike>' 
                    + states[i].primary_election.toLocaleDateString() + '</strike>');
            
            } else {
                row_cells[4].innerHTML = states[i].primary_election.toLocaleDateString();
            }

            if(states[i].detail_url)
            {
                row_cells[5].innerHTML = ('<a href="' + states[i].detail_url + '">' 
                    + 'Ballotpedia</a>');
            }

            table_body.appendChild(new_row);
        }
    }

    load_candidates('{{candidates_url}}');
    load_states('{{states_url}}');

</script>

</body>
</html>
